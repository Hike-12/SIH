{% load static %}
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH"
      crossorigin="anonymous"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="{% block css %}{% endblock css %}"
    />
    <link rel="stylesheet" type="text/css" href="{% static 'css/quiz.css' %}" />
    <title>Quiz</title>
  </head>
  <body>
    <div class="chatbox">
      <form id="chat-form" method="post">
        {% csrf_token %}
        <div id="messages"></div>
        <div id="message" class="search-bar">
          <input
            type="text"
            id="ai-input"
            placeholder="Type your message here..."
            onkeydown="checkEnter(event)"
          />
          <button type="button" class="ai-submit" onclick="sendMessage()">
            <img class="arrow" src="/static/images/arrow.png" />
          </button>
        </div>
        <div class="TextToSpeech" id="TTS">
          <button type="button" onclick="TextToSpeech()">Text to Speech</button>
        </div>
      </form>
    </div>

    <script>
      function formatText(text) {
        let formattedText = text.replace(
          /\*\*(.*?)\*\*/g,
          "<strong>$1</strong>"
        );
        formattedText = formattedText.replace(/\n/g, "<br>");
        return formattedText;
      }

      const csrftoken = document.querySelector(
        "[name=csrfmiddlewaretoken]"
      ).value;
      let lastBotResponse = "";
      let speechSynthesisActive = false;
      let currentSpeech;

      async function sendMessage() {
        const message = document.getElementById("ai-input").value.trim();
        if (message === "") return;

        try {
          const response = await fetch("", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
              "X-CSRFToken": csrftoken,
            },
            body: new URLSearchParams({ message: message }),
          });

          if (!response.ok) throw new Error("Network response was not ok");

          const data = await response.json();
          const userMessage = formatText(message);
          const botResponse = formatText(data.response);

          document.getElementById("messages").innerHTML += `
        <div class="message-container">
            <div class="user-message">User: ${userMessage}</div>
        </div>
        <div class="message-container bot-message-container">
            <div class="bot-message">Bot: ${botResponse}</div>
        </div>
      `;

          lastBotResponse = data.response;

          document.getElementById("ai-input").value = "";
          document.getElementById("messages").scrollTop =
            document.getElementById("messages").scrollHeight;
        } catch (error) {
          console.error("There was a problem with the fetch operation:", error);
        }
      }

      function checkEnter(event) {
        if (event.key === "Enter") {
          event.preventDefault();
          sendMessage();
        }
      }

      function speakText(text) {
        var speech = new SpeechSynthesisUtterance(text);
        window.speechSynthesis.speak(speech);
        return speech;
      }

      function TextToSpeech() {
        if (speechSynthesisActive) {
          window.speechSynthesis.cancel();
          speechSynthesisActive = false;
        } else {
          currentSpeech = speakText(lastBotResponse);
          speechSynthesisActive = true;
          currentSpeech.onend = function () {
            speechSynthesisActive = false;
          };
        }
      }
    </script>
  </body>
</html>
